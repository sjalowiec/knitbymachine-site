---
import BaseLayout from '../layouts/BaseLayout.astro';

// Fetch ANA entries from GitHub at build time
let entries = [];
let errorMessage = '';

try {
  const response = await fetch('https://api.github.com/repos/sjalowiec/knitbymachine/contents/src/content/ana');
  
  if (response.ok) {
    const files = await response.json();
    
    // Fetch each JSON file's content
    const entryPromises = files
      .filter(file => file.name.endsWith('.json'))
      .map(async (file) => {
        const fileResponse = await fetch(file.download_url);
        const data = await fileResponse.json();
        return {
          title: data.title,
          slug: data.slug,
          category: data.category || 'Uncategorized',
          tags: data.tags || [],
          isDraft: data.isDraft,
          pendingPublish: data.pendingPublish,
          publishedDate: data.publishedDate,
        };
      });
    
    const allEntries = await Promise.all(entryPromises);
    // Filter out drafts and pending publish entries
    entries = allEntries.filter(entry => !entry.isDraft && !entry.pendingPublish);
  }
} catch (error) {
  console.error('Error fetching ANA entries:', error);
  errorMessage = error.message;
}

const title = "Ask 'n Answer Catalogue";
const description = "Browse all our knitting machine questions and answers, organized by topic. Find solutions to troubleshooting, techniques, machines, and more.";
---

<BaseLayout {title} {description}>
  <div class="page-container">
    <!-- Compact Header: Icon + Text + Search/Sort -->
    <div class="header-panel fade-in">
      <img src="https://knitbymachine.com/assets/icons/asknanswer-icon.svg" alt="Ask 'n Answer" class="intro-icon">
      <div class="intro-content">
        <p class="intro-tagline">Troubleshoot, learn, and master your knitting machine — one question at a time.</p>
        <p class="intro-subtitle">Because understanding your machine shouldn't be a mystery. You're not alone — every knitter has questions, and every question leads to a new "aha" moment.</p>
      </div>
      <div class="controls-wrapper">
        <div class="search-wrapper">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="Search ANA questions..."
            aria-label="Search questions"
          >
        </div>
        <div class="sort-wrapper">
          <label for="sortSelect" class="sort-label">Sort by:</label>
          <select id="sortSelect" class="sort-select" aria-label="Sort order">
            <option value="newest">Newest</option>
            <option value="oldest">Oldest</option>
            <option value="alphabetical">Alphabetical</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Subtle Divider -->
    <hr class="header-divider">

    <!-- Catalogue Content -->
    <div id="catalogueContent" class="catalogue-content" data-entries={JSON.stringify(entries)}>
      {errorMessage && (
        <div class="error">
          <p><strong>Error loading questions</strong></p>
          <p>Unable to fetch ANA entries. Please try again later.</p>
          <p style="font-size: 0.9rem; margin-top: 1rem;">{errorMessage}</p>
        </div>
      )}
    </div>
  </div>

  <!-- Scroll to Top Button -->
  <button id="scrollToTop" class="scroll-to-top" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
  </button>
</BaseLayout>

<style>
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4.5rem 1.5rem 3rem;
  }

  /* Compact Header Panel */
  .header-panel {
    background-color: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(82, 104, 45, 0.1);
    padding: 1.8rem 2.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
  }

  .intro-icon {
    width: 200px;
    height: 200px;
    flex-shrink: 0;
  }

  .intro-content {
    flex: 1;
    min-width: 300px;
  }

  .intro-tagline {
    color: #52682D;
    font-size: 1.25rem;
    line-height: 1.5;
    margin: 0 0 0.75rem 0;
    opacity: 0.85;
  }

  .intro-subtitle {
    color: #52682D;
    font-size: 1rem;
    line-height: 1.6;
    margin: 0;
    opacity: 0.7;
    max-width: 580px;
  }

  /* Search and Sort Controls */
  .controls-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    min-width: 280px;
  }

  .search-wrapper {
    width: 100%;
  }

  .search-input {
    width: 100%;
    padding: 0.875rem 1.25rem;
    border: 2px solid #c7d8a4;
    border-radius: 50px;
    font-size: 1rem;
    background-color: white;
    transition: all 0.3s ease;
  }

  .search-input:focus {
    outline: none;
    border-color: #52682D;
    box-shadow: 0 0 0 3px rgba(82, 104, 45, 0.1);
  }

  .sort-wrapper {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sort-label {
    color: #52682D;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .sort-select {
    padding: 0.75rem 1rem;
    border: 2px solid #c7d8a4;
    border-radius: 50px;
    font-size: 0.95rem;
    background-color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    flex: 1;
  }

  .sort-select:focus {
    outline: none;
    border-color: #52682D;
    box-shadow: 0 0 0 3px rgba(82, 104, 45, 0.1);
  }

  /* Header Divider */
  .header-divider {
    border: none;
    height: 1px;
    background-color: #a9b88f;
    width: 90%;
    margin: 1.5rem auto 3rem;
  }

  /* Catalogue Content */
  .catalogue-content {
    position: relative;
  }

  /* Consistent Section Titles */
  :global(.section-title) {
    color: #52682D;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    padding-bottom: 0.75rem;
    position: relative;
  }

  :global(.section-title::after) {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 3px;
    background-color: #52682D;
    border-radius: 2px;
  }

  /* Section Rhythm and Balance */
  :global(.category-section) {
    margin-bottom: 4rem;
    padding: 2.5rem;
    border-radius: 12px;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  :global(.category-section:nth-child(odd)) {
    background-color: #ffffff;
  }

  :global(.category-section:nth-child(even)) {
    background-color: #f9fdf5;
  }

  :global(.category-section.hidden) {
    display: none;
  }

  :global(.row-wrapper) {
    display: flex;
    align-items: center;
    gap: 1rem;
    position: relative;
    margin-top: 1.5rem;
  }

  :global(.scrollable-row) {
    flex: 1;
    overflow-x: auto;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #c7d8a4 transparent;
    padding: 0.5rem 1rem 1rem 0.5rem;
    scroll-behavior: smooth;
    scroll-snap-type: x mandatory;
    cursor: grab;
  }

  :global(.scrollable-row:active) {
    cursor: grabbing;
  }

  :global(.scrollable-row::-webkit-scrollbar) {
    height: 6px;
  }

  :global(.scrollable-row::-webkit-scrollbar-track) {
    background: transparent;
  }

  :global(.scrollable-row::-webkit-scrollbar-thumb) {
    background-color: #c7d8a4;
    border-radius: 10px;
  }

  :global(.bubbles-container) {
    display: flex;
    gap: 1rem;
    padding: 0.5rem 0.5rem 0.5rem 2rem;
    min-width: min-content;
  }

  :global(.scroll-arrow) {
    width: 44px;
    height: 44px;
    min-width: 44px;
    border-radius: 50%;
    background-color: #c7d8a4;
    border: 2px solid #52682D;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(82, 104, 45, 0.15);
    flex-shrink: 0;
  }

  :global(.scroll-arrow:hover) {
    background-color: #52682D;
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(82, 104, 45, 0.25);
  }

  :global(.scroll-arrow svg) {
    width: 22px;
    height: 22px;
    fill: #52682D;
    transition: fill 0.3s ease;
  }

  :global(.scroll-arrow:hover svg) {
    fill: white;
  }

  :global(.scroll-arrow.hidden) {
    opacity: 0.3;
    pointer-events: none;
  }

  /* Interactive Question Bubbles with Animation */
  :global(.thought-bubble) {
    position: relative;
    background-color: #ffffff;
    color: #52682D;
    border: 1px solid #c7d8a4;
    padding: 1.25rem 1.75rem;
    border-radius: 25px;
    text-decoration: none;
    font-size: 1.1rem;
    font-weight: 500;
    white-space: normal;
    max-width: 280px;
    min-width: 180px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    cursor: pointer;
    flex-shrink: 0;
    scroll-snap-align: start;
    word-wrap: break-word;
    hyphens: auto;
    opacity: 0;
    transform: translateY(20px);
  }

  /* Scroll-triggered animation states */
  :global(.thought-bubble.animate-in) {
    opacity: 1;
    transform: translateY(0);
  }

  :global(.thought-bubble::before) {
    content: '';
    position: absolute;
    left: -14px;
    bottom: 20px;
    width: 12px;
    height: 12px;
    background-color: #ffffff;
    border: 1px solid #c7d8a4;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  :global(.thought-bubble::after) {
    content: '';
    position: absolute;
    left: -24px;
    bottom: 12px;
    width: 8px;
    height: 8px;
    background-color: #ffffff;
    border: 1px solid #c7d8a4;
    border-radius: 50%;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
  }

  /* Hover effects - lift and grow */
  :global(.thought-bubble:hover) {
    background-color: #eef4e5;
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
  }

  :global(.thought-bubble:hover::before),
  :global(.thought-bubble:hover::after) {
    background-color: #eef4e5;
  }

  :global(.thought-bubble.bubble-hidden) {
    display: none;
  }

  /* Scroll to Top Button */
  .scroll-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #52682D;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(82, 104, 45, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
  }

  .scroll-to-top.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }

  .scroll-to-top:hover {
    background-color: #3e5023;
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(82, 104, 45, 0.4);
  }

  .scroll-to-top svg {
    width: 24px;
    height: 24px;
  }

  /* Smooth Motion and Transitions */
  .fade-in {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .error {
    text-align: center;
    padding: 3rem;
    color: #d64545;
    background-color: #ffe5e5;
    border-radius: 10px;
    margin: 2rem;
  }

  :global(.no-results) {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-style: italic;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .page-container {
      padding: 2rem 1rem;
    }

    .header-panel {
      flex-direction: column;
      text-align: center;
      padding: 1.5rem;
      gap: 1.25rem;
    }

    .intro-icon {
      width: 120px;
      height: 120px;
    }

    .intro-content {
      min-width: unset;
    }

    .intro-tagline {
      font-size: 1.1rem;
    }

    .intro-subtitle {
      font-size: 0.95rem;
      max-width: 100%;
    }

    .controls-wrapper {
      width: 100%;
      min-width: unset;
    }

    .search-wrapper,
    .sort-wrapper {
      width: 100%;
    }

    .sort-wrapper {
      justify-content: space-between;
    }

    :global(.category-section) {
      padding: 1.5rem 1rem;
      margin-bottom: 2.5rem;
    }

    :global(.section-title) {
      font-size: 1.5rem;
    }

    :global(.thought-bubble) {
      font-size: 0.95rem;
      padding: 1rem 1.5rem;
      min-width: 160px;
    }

    .scroll-to-top {
      bottom: 1.5rem;
      right: 1.5rem;
      width: 45px;
      height: 45px;
    }
  }
</style>

<script>
  let allEntries = [];
  let currentSort = 'newest';

  function sortEntries(entries, sortBy) {
    const sorted = [...entries];
    
    switch(sortBy) {
      case 'newest':
        sorted.sort((a, b) => {
          const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
          const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
          return dateB - dateA;
        });
        break;
      case 'oldest':
        sorted.sort((a, b) => {
          const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
          const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
          return dateA - dateB;
        });
        break;
      case 'alphabetical':
        sorted.sort((a, b) => a.title.localeCompare(b.title));
        break;
    }
    
    return sorted;
  }

  function groupByCategory(entries) {
    const grouped = {};
    entries.forEach(entry => {
      if (!grouped[entry.category]) {
        grouped[entry.category] = [];
      }
      grouped[entry.category].push(entry);
    });
    return grouped;
  }

  function renderCatalogue(entries) {
    const container = document.getElementById('catalogueContent');
    const sortedEntries = sortEntries(entries, currentSort);
    const grouped = groupByCategory(sortedEntries);
    const categories = Object.keys(grouped).sort();

    if (categories.length === 0) {
      container.innerHTML = '<div class="no-results">No questions found matching your search.</div>';
      return;
    }

    let html = '';

    categories.forEach(category => {
      const categoryEntries = grouped[category];
      const rowId = category.replace(/\s+/g, '-').toLowerCase();

      html += `
        <div class="category-section" data-category="${category}">
          <h2 class="section-title">${category}</h2>
          <div class="row-wrapper">
            <button class="scroll-arrow left" data-row="${rowId}" aria-label="Scroll left">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
              </svg>
            </button>
            <div class="scrollable-row" data-row-id="${rowId}">
              <div class="bubbles-container">
                ${categoryEntries.map(entry => `
                  <a href="/ana/${entry.slug}"
                    class="thought-bubble"
                    data-title="${entry.title.toLowerCase()}"
                    data-tags="${entry.tags.join(' ').toLowerCase()}">
                    ${entry.title}
                  </a>
                `).join('')}
              </div>
            </div>
            <button class="scroll-arrow right" data-row="${rowId}" aria-label="Scroll right">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
              </svg>
            </button>
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
    
    // Initialize scroll animations after render
    setTimeout(() => {
      initializeScrollAnimations();
      initializeScrollingEnhancements();
    }, 100);
  }

  // Intersection Observer for scroll-triggered bubble animations (wave effect)
  function initializeScrollAnimations() {
    const bubbles = document.querySelectorAll('.thought-bubble');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          // Stagger animation with wave effect
          setTimeout(() => {
            entry.target.classList.add('animate-in');
          }, index * 50); // 50ms delay between each bubble
          
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    bubbles.forEach(bubble => {
      observer.observe(bubble);
    });
  }

  function filterCatalogue(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const sections = document.querySelectorAll('.category-section');

    sections.forEach(section => {
      const bubbles = section.querySelectorAll('.thought-bubble');
      let hasVisibleBubbles = false;

      bubbles.forEach(bubble => {
        const title = bubble.dataset.title;
        const tags = bubble.dataset.tags;
        const matches = title.includes(term) || tags.includes(term);

        if (matches) {
          bubble.classList.remove('bubble-hidden');
          hasVisibleBubbles = true;
        } else {
          bubble.classList.add('bubble-hidden');
        }
      });

      if (hasVisibleBubbles) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    });
    
    setTimeout(() => {
      document.querySelectorAll('.scrollable-row').forEach(row => {
        updateArrowVisibility(row);
      });
    }, 50);
  }

  function updateArrowVisibility(row) {
    const rowId = row.dataset.rowId;
    const leftArrow = document.querySelector(`.scroll-arrow.left[data-row="${rowId}"]`);
    const rightArrow = document.querySelector(`.scroll-arrow.right[data-row="${rowId}"]`);
    
    if (leftArrow && rightArrow) {
      const isAtStart = row.scrollLeft <= 0;
      const isAtEnd = row.scrollLeft >= row.scrollWidth - row.clientWidth - 1;
      
      leftArrow.classList.toggle('hidden', isAtStart);
      rightArrow.classList.toggle('hidden', isAtEnd);
    }
  }

  function initializeScrollingEnhancements() {
    const scrollableRows = document.querySelectorAll('.scrollable-row');
    
    scrollableRows.forEach(row => {
      let isDown = false;
      let startX;
      let scrollLeft;
      
      row.addEventListener('mousedown', (e) => {
        if (e.target.closest('.thought-bubble')) return;
        
        isDown = true;
        startX = e.pageX - row.offsetLeft;
        scrollLeft = row.scrollLeft;
      });
      
      row.addEventListener('mouseleave', () => {
        isDown = false;
      });
      
      row.addEventListener('mouseup', () => {
        isDown = false;
      });
      
      row.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - row.offsetLeft;
        const walk = (x - startX) * 2;
        row.scrollLeft = scrollLeft - walk;
      });
      
      row.addEventListener('scroll', () => updateArrowVisibility(row));
      updateArrowVisibility(row);
    });

    const arrows = document.querySelectorAll('.scroll-arrow');
    arrows.forEach(arrow => {
      arrow.addEventListener('click', () => {
        const rowId = arrow.dataset.row;
        const row = document.querySelector(`.scrollable-row[data-row-id="${rowId}"]`);
        
        if (row) {
          const scrollAmount = arrow.classList.contains('left') ? -300 : 300;
          row.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
      });
    });
  }

  // Scroll to Top Button
  function initializeScrollToTop() {
    const scrollBtn = document.getElementById('scrollToTop');
    
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    });

    scrollBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  }

  function init() {
    const container = document.getElementById('catalogueContent');
    const entriesData = container.getAttribute('data-entries');
    
    if (entriesData) {
      allEntries = JSON.parse(entriesData);
      renderCatalogue(allEntries);
    }

    initializeScrollToTop();
  }

  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    filterCatalogue(e.target.value);
  });

  document.getElementById('sortSelect')?.addEventListener('change', (e) => {
    currentSort = e.target.value;
    renderCatalogue(allEntries);
    const searchTerm = document.getElementById('searchInput').value;
    if (searchTerm) {
      filterCatalogue(searchTerm);
    }
  });

  init();
</script>
