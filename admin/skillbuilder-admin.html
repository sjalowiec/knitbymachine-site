<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Skill Builder Admin | Knit by Machine</title>
<style>
:root{
  --kbm-green:#52682D;
  --kbm-olive:#738C52;
  --kbm-gray:#f6f7f8;
  --kbm-dark:#333;
  --radius:14px;
}
*{box-sizing:border-box}
body{font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--kbm-gray);color:var(--kbm-dark);margin:0;padding:20px}

.admin-container{max-width:1400px;margin:0 auto}
.admin-header{background:#fff;padding:20px 24px;border-radius:var(--radius);margin-bottom:20px;border:1px solid #e7e9eb}
.admin-header h1{margin:0 0 8px;color:var(--kbm-green)}
.admin-header p{margin:0;color:#666}

.admin-layout{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.admin-panel{background:#fff;padding:24px;border-radius:var(--radius);border:1px solid #e7e9eb}
.admin-panel h2{margin:0 0 20px;color:var(--kbm-green);font-size:1.3rem}

/* Form styles */
.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:6px;font-weight:600;color:var(--kbm-green)}
.form-group input[type="text"],
.form-group textarea{width:100%;padding:10px;border:1px solid #d8dde3;border-radius:10px;font-family:inherit}
.form-group textarea{min-height:80px;resize:vertical}
.form-group .hint{font-size:0.85rem;color:#666;margin-top:4px}

/* Checkbox */
.checkbox-group{display:flex;align-items:center;gap:8px}
.checkbox-group input{accent-color:var(--kbm-olive)}

/* Repeater fields */
.repeater{border:1px dashed #ccd1d5;border-radius:10px;padding:16px;margin-top:10px}
.repeater-item{background:var(--kbm-gray);padding:14px;border-radius:8px;margin-bottom:10px;position:relative}
.repeater-item .remove-btn{position:absolute;top:8px;right:8px;background:#dc3545;color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:0.75rem;cursor:pointer}
.repeater-item .remove-btn:hover{background:#c82333}

/* Buttons */
.btn{border:1px solid #d5dadf;background:#fff;border-radius:10px;padding:10px 16px;font-weight:600;cursor:pointer;font-size:0.95rem}
.btn.primary{background:var(--kbm-olive);color:#fff;border-color:var(--kbm-olive)}
.btn.primary:hover{background:var(--kbm-green)}
.btn.secondary{background:#6c757d;color:#fff;border-color:#6c757d}
.btn.secondary:hover{background:#5a6268}
.btn-group{display:flex;gap:10px;margin-top:20px}

/* Preview iframe */
#preview-frame{width:100%;height:800px;border:1px solid #dee2e6;border-radius:10px;background:#fff}

.sticky-actions{position:sticky;top:20px;background:#fff;padding:16px;border-radius:var(--radius);border:1px solid #e7e9eb;margin-bottom:20px}

@media (max-width:1200px){
  .admin-layout{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="admin-container">
  <div class="admin-header">
    <h1>Skill Builder Admin</h1>
    <p>Create and export skill builder content as JSON. Preview updates live.</p>
  </div>

  <div class="admin-layout">
    <!-- FORM PANEL -->
    <div>
      <div class="sticky-actions">
        <div class="btn-group">
          <button class="btn primary" id="previewBtn">Update Preview</button>
          <button class="btn primary" id="exportBtn">Export JSON</button>
          <button class="btn secondary" id="importBtn">Import JSON</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none">
      </div>

      <div class="admin-panel">
        <h2>Basic Information</h2>
        
        <div class="form-group">
          <label for="sb-id">Skill Builder ID</label>
          <input type="text" id="sb-id" placeholder="e.g., increase" value="increase">
          <div class="hint">Lowercase, no spaces (used for localStorage keys)</div>
        </div>

        <div class="form-group">
          <label for="sb-title">Title</label>
          <input type="text" id="sb-title" placeholder="e.g., Increase Skill Builder" value="Increase Skill Builder">
        </div>

        <div class="form-group">
          <label for="sb-intro">Introduction</label>
          <textarea id="sb-intro" placeholder="Main description of what this skill builder teaches">Practice four ways to add stitches. Watch a tiny clip, try it on your machine, then mark it done. You are building confidence one swatch at a time.</textarea>
        </div>

        <div class="form-group">
          <label for="sb-tagline">Tagline</label>
          <input type="text" id="sb-tagline" placeholder="Inspirational quote or motto" value="You will learn more by doing than by watching.">
        </div>

        <div class="form-group">
          <div class="checkbox-group">
            <input type="checkbox" id="sb-member" checked>
            <label for="sb-member" style="margin:0">Member-only content</label>
          </div>
        </div>
      </div>

      <div class="admin-panel">
        <h2>Pre-flight Checklist</h2>
        <div class="form-group">
          <label>Checklist Items</label>
          <div id="checklist-container" class="repeater"></div>
          <button class="btn" id="addChecklistBtn">+ Add Item</button>
        </div>
      </div>

      <div class="admin-panel">
        <h2>Checklist Instructions</h2>
        <div class="form-group">
          <label>Detailed Instructions</label>
          <div id="instructions-container" class="repeater"></div>
          <button class="btn" id="addInstructionBtn">+ Add Instruction</button>
        </div>
      </div>

      <div class="admin-panel">
        <h2>Steps</h2>
        <div id="steps-container"></div>
        <button class="btn" id="addStepBtn">+ Add Step</button>
      </div>

      <div class="admin-panel">
        <h2>Reflection</h2>
        <div class="form-group">
          <label>Reflection Prompts</label>
          <div id="prompts-container" class="repeater"></div>
          <button class="btn" id="addPromptBtn">+ Add Prompt</button>
        </div>

        <div class="form-group">
          <label>Quick Reactions</label>
          <div id="reactions-container" class="repeater"></div>
          <button class="btn" id="addReactionBtn">+ Add Reaction</button>
        </div>
      </div>

      <div class="admin-panel">
        <h2>Next Steps / Related Content</h2>
        <div id="nextsteps-container"></div>
        <button class="btn" id="addNextStepBtn">+ Add Next Step</button>
      </div>
    </div>

    <!-- PREVIEW PANEL -->
    <div>
      <div class="admin-panel" style="position:sticky;top:20px">
        <h2>Live Preview</h2>
        <iframe id="preview-frame" title="Skill Builder Preview"></iframe>
      </div>
    </div>
  </div>
</div>

<script src="../public/js/skillbuilder.js"></script>
<script>
(function(){
  'use strict';

  // Initialize with default data
  const defaultData = {
    id: 'increase',
    title: 'Increase Skill Builder',
    intro: 'Practice four ways to add stitches. Watch a tiny clip, try it on your machine, then mark it done. You are building confidence one swatch at a time.',
    tagline: 'You will learn more by doing than by watching.',
    memberOnly: true,
    preChecklist: ['Yarn ready', 'Cast-on comb', 'Tension set', 'Notebook nearby'],
    checklistInstructions: [
      'Cast on 20 sts with waste yarn, change to main yarn, knit 10 rows.',
      'Set a consistent tension. Note it in your notebook.',
      'Work each increase method for at least 20 rows to see the line.',
      'Label each swatch. Take a photo if you can.'
    ],
    steps: [
      {
        title: 'Transfer (edge increase)',
        duration: '~10 sec',
        description: 'Work 10 rows. Transfer one stitch outward to an empty needle to add a stitch while keeping a clean edge.',
        tips: ['Use a 1-prong tool so the edge stays tidy.', 'Move the stitch away from the edge before knitting the next row.'],
        mediaType: 'placeholder',
        mediaFile: ''
      }
    ],
    reflectionPrompts: ['What did you notice?', 'Which method do you prefer for edges vs center shaping?'],
    reactions: [
      { id: 'clean-line', emoji: 'ðŸ‘', label: 'Clean line' },
      { id: 'blend', emoji: 'ðŸŽ¯', label: 'Blends best' }
    ],
    nextSteps: [
      { title: 'Decrease Skill Builder', description: 'Mirror this practice with four decrease methods.', link: '#', buttonText: 'Open' }
    ]
  };

  function loadFormData(data) {
    document.getElementById('sb-id').value = data.id || '';
    document.getElementById('sb-title').value = data.title || '';
    document.getElementById('sb-intro').value = data.intro || '';
    document.getElementById('sb-tagline').value = data.tagline || '';
    document.getElementById('sb-member').checked = data.memberOnly || false;

    // Checklist
    const checklistContainer = document.getElementById('checklist-container');
    checklistContainer.innerHTML = '';
    (data.preChecklist || []).forEach((item, i) => addChecklistItem(item, i));

    // Instructions
    const instructionsContainer = document.getElementById('instructions-container');
    instructionsContainer.innerHTML = '';
    (data.checklistInstructions || []).forEach((item, i) => addInstructionItem(item, i));

    // Steps
    const stepsContainer = document.getElementById('steps-container');
    stepsContainer.innerHTML = '';
    (data.steps || []).forEach((step, i) => addStepItem(step, i));

    // Prompts
    const promptsContainer = document.getElementById('prompts-container');
    promptsContainer.innerHTML = '';
    (data.reflectionPrompts || []).forEach((item, i) => addPromptItem(item, i));

    // Reactions
    const reactionsContainer = document.getElementById('reactions-container');
    reactionsContainer.innerHTML = '';
    (data.reactions || []).forEach((reaction, i) => addReactionItem(reaction, i));

    // Next steps
    const nextStepsContainer = document.getElementById('nextsteps-container');
    nextStepsContainer.innerHTML = '';
    (data.nextSteps || []).forEach((step, i) => addNextStepItem(step, i));
  }

  function addChecklistItem(value = '', index = null) {
    const container = document.getElementById('checklist-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater-item';
    div.innerHTML = `
      <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
      <input type="text" placeholder="Checklist item" value="${escapeHtml(value)}" data-field="checklist-${id}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
    `;
    container.appendChild(div);
  }

  function addInstructionItem(value = '', index = null) {
    const container = document.getElementById('instructions-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater-item';
    div.innerHTML = `
      <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
      <textarea placeholder="Instruction step" data-field="instruction-${id}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;min-height:60px">${escapeHtml(value)}</textarea>
    `;
    container.appendChild(div);
  }

  function addPromptItem(value = '', index = null) {
    const container = document.getElementById('prompts-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater-item';
    div.innerHTML = `
      <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
      <input type="text" placeholder="Reflection prompt" value="${escapeHtml(value)}" data-field="prompt-${id}" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
    `;
    container.appendChild(div);
  }

  function addStepItem(step = {}, index = null) {
    const container = document.getElementById('steps-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater';
    div.style.marginBottom = '16px';
    
    const tipsHtml = (step.tips || ['']).map((tip, i) => 
      `<div style="margin-bottom:8px">
        <input type="text" placeholder="Tip" value="${escapeHtml(tip)}" data-field="step-${id}-tip-${i}" style="width:calc(100% - 70px);padding:6px;border:1px solid #ccc;border-radius:6px">
        <button onclick="this.parentElement.remove()" style="padding:6px 10px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;margin-left:4px">Remove</button>
      </div>`
    ).join('');

    div.innerHTML = `
      <div style="position:relative">
        <button class="remove-btn" onclick="this.parentElement.parentElement.remove()">Remove Step</button>
        <h3 style="margin:0 0 12px;color:var(--kbm-green)">Step ${id + 1}</h3>
      </div>
      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:4px;font-weight:600">Title</label>
        <input type="text" placeholder="Step title" value="${escapeHtml(step.title || '')}" data-field="step-${id}-title" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:4px;font-weight:600">Duration</label>
        <input type="text" placeholder="e.g., ~10 sec" value="${escapeHtml(step.duration || '')}" data-field="step-${id}-duration" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:4px;font-weight:600">Description</label>
        <textarea placeholder="What to do" data-field="step-${id}-description" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;min-height:60px">${escapeHtml(step.description || '')}</textarea>
      </div>
      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:4px;font-weight:600">Media File</label>
        <input type="text" placeholder="filename.gif or filename.mp4" value="${escapeHtml(step.mediaFile || '')}" data-field="step-${id}-media" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
      <div style="margin-bottom:10px">
        <label style="display:block;margin-bottom:4px;font-weight:600">Tips</label>
        <div data-field="step-${id}-tips">${tipsHtml}</div>
        <button onclick="addTipToStep(${id})" style="padding:6px 12px;background:var(--kbm-olive);color:#fff;border:none;border-radius:6px;cursor:pointer;margin-top:6px">+ Add Tip</button>
      </div>
    `;
    container.appendChild(div);
  }

  function addReactionItem(reaction = {}, index = null) {
    const container = document.getElementById('reactions-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater-item';
    div.innerHTML = `
      <button class="remove-btn" onclick="this.parentElement.remove()">Remove</button>
      <div style="display:grid;grid-template-columns:80px 80px 1fr;gap:8px">
        <input type="text" placeholder="ID" value="${escapeHtml(reaction.id || '')}" data-field="reaction-${id}-id" style="padding:8px;border:1px solid #ccc;border-radius:6px">
        <input type="text" placeholder="Emoji" value="${escapeHtml(reaction.emoji || '')}" data-field="reaction-${id}-emoji" style="padding:8px;border:1px solid #ccc;border-radius:6px">
        <input type="text" placeholder="Label" value="${escapeHtml(reaction.label || '')}" data-field="reaction-${id}-label" style="padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
    `;
    container.appendChild(div);
  }

  function addNextStepItem(step = {}, index = null) {
    const container = document.getElementById('nextsteps-container');
    const id = index !== null ? index : container.children.length;
    const div = document.createElement('div');
    div.className = 'repeater';
    div.style.marginBottom = '16px';
    div.innerHTML = `
      <div style="position:relative">
        <button class="remove-btn" onclick="this.parentElement.parentElement.remove()">Remove</button>
        <h4 style="margin:0 0 10px;color:var(--kbm-green)">Next Step ${id + 1}</h4>
      </div>
      <div style="margin-bottom:8px">
        <input type="text" placeholder="Title" value="${escapeHtml(step.title || '')}" data-field="nextstep-${id}-title" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
      <div style="margin-bottom:8px">
        <input type="text" placeholder="Description" value="${escapeHtml(step.description || '')}" data-field="nextstep-${id}-description" style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
      <div style="display:grid;grid-template-columns:1fr 120px;gap:8px">
        <input type="text" placeholder="Link URL" value="${escapeHtml(step.link || '')}" data-field="nextstep-${id}-link" style="padding:8px;border:1px solid #ccc;border-radius:6px">
        <input type="text" placeholder="Button text" value="${escapeHtml(step.buttonText || '')}" data-field="nextstep-${id}-button" style="padding:8px;border:1px solid #ccc;border-radius:6px">
      </div>
    `;
    container.appendChild(div);
  }

  window.addTipToStep = function(stepId) {
    const tipsContainer = document.querySelector(`[data-field="step-${stepId}-tips"]`);
    const tipId = tipsContainer.children.length;
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <input type="text" placeholder="Tip" value="" data-field="step-${stepId}-tip-${tipId}" style="width:calc(100% - 70px);padding:6px;border:1px solid #ccc;border-radius:6px">
      <button onclick="this.parentElement.remove()" style="padding:6px 10px;background:#dc3545;color:#fff;border:none;border-radius:6px;cursor:pointer;margin-left:4px">Remove</button>
    `;
    tipsContainer.appendChild(div);
  };

  function gatherFormData() {
    const data = {
      id: document.getElementById('sb-id').value,
      title: document.getElementById('sb-title').value,
      intro: document.getElementById('sb-intro').value,
      tagline: document.getElementById('sb-tagline').value,
      memberOnly: document.getElementById('sb-member').checked,
      preChecklist: [],
      checklistInstructions: [],
      steps: [],
      reflectionPrompts: [],
      reactions: [],
      nextSteps: []
    };

    // Gather checklist
    document.querySelectorAll('[data-field^="checklist-"]').forEach(input => {
      if (input.value.trim()) data.preChecklist.push(input.value);
    });

    // Gather instructions
    document.querySelectorAll('[data-field^="instruction-"]').forEach(input => {
      if (input.value.trim()) data.checklistInstructions.push(input.value);
    });

    // Gather prompts
    document.querySelectorAll('[data-field^="prompt-"]').forEach(input => {
      if (input.value.trim()) data.reflectionPrompts.push(input.value);
    });

    // Gather steps
    const stepContainers = document.getElementById('steps-container').children;
    for (let i = 0; i < stepContainers.length; i++) {
      const title = document.querySelector(`[data-field="step-${i}-title"]`)?.value || '';
      const duration = document.querySelector(`[data-field="step-${i}-duration"]`)?.value || '';
      const description = document.querySelector(`[data-field="step-${i}-description"]`)?.value || '';
      const mediaFile = document.querySelector(`[data-field="step-${i}-media"]`)?.value || '';
      
      const tips = [];
      document.querySelectorAll(`[data-field^="step-${i}-tip-"]`).forEach(input => {
        if (input.value.trim()) tips.push(input.value);
      });

      data.steps.push({
        title,
        duration,
        description,
        tips,
        mediaType: mediaFile ? (mediaFile.endsWith('.mp4') ? 'video' : 'gif') : 'placeholder',
        mediaFile
      });
    }

    // Gather reactions
    const reactionContainers = document.getElementById('reactions-container').children;
    for (let i = 0; i < reactionContainers.length; i++) {
      const id = document.querySelector(`[data-field="reaction-${i}-id"]`)?.value || '';
      const emoji = document.querySelector(`[data-field="reaction-${i}-emoji"]`)?.value || '';
      const label = document.querySelector(`[data-field="reaction-${i}-label"]`)?.value || '';
      if (id && label) data.reactions.push({ id, emoji, label });
    }

    // Gather next steps
    const nextStepContainers = document.getElementById('nextsteps-container').children;
    for (let i = 0; i < nextStepContainers.length; i++) {
      const title = document.querySelector(`[data-field="nextstep-${i}-title"]`)?.value || '';
      const description = document.querySelector(`[data-field="nextstep-${i}-description"]`)?.value || '';
      const link = document.querySelector(`[data-field="nextstep-${i}-link"]`)?.value || '';
      const buttonText = document.querySelector(`[data-field="nextstep-${i}-button"]`)?.value || '';
      if (title) data.nextSteps.push({ title, description, link, buttonText });
    }

    return data;
  }

  function updatePreview() {
    const data = gatherFormData();
    const iframe = document.getElementById('preview-frame');
    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
    
    // Generate preview HTML
    const html = generatePreviewHTML(data);
    iframeDoc.open();
    iframeDoc.write(html);
    iframeDoc.close();
  }

  function generatePreviewHTML(data) {
    // Use the actual template from increase/index.html but inject data inline
    return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<style>
  :root{--kbm-green:#52682D;--kbm-olive:#738C52;--kbm-gray:#f6f7f8;--kbm-dark:#333;--radius:14px}
  *{box-sizing:border-box}
  body{font-family:"Open Sans",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#fff;color:var(--kbm-dark);margin:0;padding:20px}
  .container{max-width:980px;margin:0 auto}
  .hero{display:grid;grid-template-columns:1.2fr .8fr;gap:20px;margin:18px 0 8px}
  .hero .title{padding:20px;border-radius:var(--radius);background:linear-gradient(180deg,#fff,var(--kbm-gray));border:1px solid #e7e9eb}
  .hero h1{margin:0 0 6px;color:var(--kbm-green)}
  .hero p{margin:6px 0 0;font-size:1.05rem}
  .tagline{font-family:"Shadows Into Light Two",cursive;font-size:1.25rem;color:var(--kbm-olive)}
  .hero .card{border:1px solid #e7e9eb;border-radius:var(--radius);padding:14px;background:#fff}
  .checklist{display:flex;flex-wrap:wrap;gap:10px}
  .check-pill{display:flex;gap:8px;padding:10px 12px;border:1px dashed #ccd1d5;border-radius:999px}
  .steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin:20px 0}
  .step{border:1px solid #e7e9eb;border-radius:var(--radius);background:#fff}
  .step header{padding:12px 14px;border-bottom:1px solid #eef0f2;display:flex;justify-content:space-between}
  .step header h3{margin:0;color:var(--kbm-green);font-size:1.05rem}
  .badge{font-size:.72rem;background:var(--kbm-gray);padding:4px 8px;border-radius:999px}
  .media{aspect-ratio:16/9;background:#e9ecef;display:grid;place-items:center;color:#8a8f95}
  .step .body{padding:12px 14px}
  details.tip{border-top:1px dashed #e6eaee;margin:0;padding:10px 14px}
  .member-only{display:inline-flex;gap:6px;padding:4px 8px;border-radius:999px;background:#fff5e6;border:1px solid #ffd9a6;color:#a56b00;font-size:.78rem}
</style>
</head>
<body>
<div class="container">
  <section class="hero">
    <div class="title">
      <h1>${escapeHtml(data.title)}</h1>
      <p>${escapeHtml(data.intro)}</p>
      <p class="tagline">${escapeHtml(data.tagline)}</p>
      ${data.memberOnly ? '<div style="margin-top:8px"><span class="member-only">ðŸ”’ Member benefit: saves your progress</span></div>' : ''}
    </div>
    <div class="card">
      <h3>Before you start</h3>
      <div class="checklist">
        ${data.preChecklist.map(item => `<label class="check-pill"><input type="checkbox"> ${escapeHtml(item)}</label>`).join('')}
      </div>
    </div>
  </section>
  <section class="steps">
    ${data.steps.map(step => `
      <article class="step">
        <header>
          <h3>${escapeHtml(step.title)}</h3>
          <span class="badge">${escapeHtml(step.duration)}</span>
        </header>
        <div class="media">${step.mediaFile ? `Media: ${escapeHtml(step.mediaFile)}` : 'GIF / Short clip'}</div>
        <div class="body">
          <p>${escapeHtml(step.description)}</p>
        </div>
        ${step.tips.length > 0 ? `<details class="tip"><summary>Show tips</summary><ul>${step.tips.map(t => `<li>${escapeHtml(t)}</li>`).join('')}</ul></details>` : ''}
      </article>
    `).join('')}
  </section>
</div>
</body>
</html>`;
  }

  function exportJSON() {
    const data = gatherFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${data.id || 'skillbuilder'}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function importJSON() {
    document.getElementById('importFile').click();
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // Event listeners
  document.getElementById('previewBtn').addEventListener('click', updatePreview);
  document.getElementById('exportBtn').addEventListener('click', exportJSON);
  document.getElementById('importBtn').addEventListener('click', importJSON);
  document.getElementById('addChecklistBtn').addEventListener('click', () => addChecklistItem());
  document.getElementById('addInstructionBtn').addEventListener('click', () => addInstructionItem());
  document.getElementById('addStepBtn').addEventListener('click', () => addStepItem());
  document.getElementById('addPromptBtn').addEventListener('click', () => addPromptItem());
  document.getElementById('addReactionBtn').addEventListener('click', () => addReactionItem());
  document.getElementById('addNextStepBtn').addEventListener('click', () => addNextStepItem());

  document.getElementById('importFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = JSON.parse(event.target.result);
          loadFormData(data);
          updatePreview();
        } catch (error) {
          alert('Invalid JSON file: ' + error.message);
        }
      };
      reader.readAsText(file);
    }
  });

  // Load default data on page load
  loadFormData(defaultData);
  updatePreview();
})();
</script>
</body>
</html>
