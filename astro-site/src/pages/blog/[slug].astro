---
export const prerender = false;

import Header from "../../components/header.astro";
import Footer from "../../components/footer.astro";

const { slug } = Astro.params;

const REPO_OWNER = 'sjalowiec';
const REPO_NAME = 'knitbymachine-site';

async function getBlogPost(slug: string) {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/astro-site/src/content/blog/${slug}.json`
    );

    if (!response.ok) {
      console.error(`Failed to fetch blog post: ${slug}`, response.status);
      return null;
    }

    const data = await response.json();
    const content = Buffer.from(data.content, 'base64').toString('utf-8');
    const post = JSON.parse(content);

    // Filter out drafts and pending publish
    if (post.isDraft || post.pendingPublish) {
      return null;
    }

    return {
      slug: post.slug,
      title: post.title,
      date: post.publishedDate || post.date,
      description: post.excerpt || post.description || '',
      author: post.author || 'Sue Jalowiec',
      body: post.body || '',
      tags: post.tags || [],
    };
  } catch (error) {
    console.error('Error fetching blog post:', error);
    return null;
  }
}

const post = await getBlogPost(slug);

if (!post) {
  return Astro.redirect('/blog');
}

// Schema.org structured data for SEO/AEO
const schemaData = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.title,
  "description": post.description,
  "author": {
    "@type": "Person",
    "name": post.author
  },
  "datePublished": post.date,
  "dateModified": post.date,
  "publisher": {
    "@type": "Organization",
    "name": "Knit by Machine",
    "logo": {
      "@type": "ImageObject",
      "url": "https://knitbymachine.com/images/kbm-logo.png"
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://knitbymachine.com/blog/${post.slug}`
  },
  "keywords": post.tags.join(", "),
  "articleBody": post.body.replace(/<[^>]*>/g, ''),
  "url": `https://knitbymachine.com/blog/${post.slug}`
};
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{post.title} | KBM Blog</title>
    <meta name="description" content={post.description} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article" />
    <meta property="og:url" content={`https://knitbymachine.com/blog/${post.slug}`} />
    <meta property="og:title" content={post.title} />
    <meta property="og:description" content={post.description} />
    <meta property="article:published_time" content={post.date} />
    <meta property="article:author" content={post.author} />
    {post.tags.map(tag => <meta property="article:tag" content={tag} />)}
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content={`https://knitbymachine.com/blog/${post.slug}`} />
    <meta name="twitter:title" content={post.title} />
    <meta name="twitter:description" content={post.description} />
    
    <!-- Schema.org structured data -->
    <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />
  </head>
  <body>
    <Header />
    
    <main class="blog-post">
      <article class="article-container">
        <header class="article-header">
          <a href="/blog" class="back-link">← Back to Blog</a>
          
          <time class="article-date" datetime={post.date}>
            {new Date(post.date).toLocaleDateString('en-US', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </time>
          
          <h1 class="article-title">{post.title}</h1>
          
          {post.author && (
            <p class="article-author">By {post.author}</p>
          )}
        </header>

        <div class="article-content" set:html={post.body} />

        {post.tags && post.tags.length > 0 && (
          <footer class="article-footer">
            <div class="article-tags">
              {post.tags.map((tag: string) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          </footer>
        )}

        <div class="article-nav">
          <a href="/blog" class="nav-button">← Back to Blog</a>
        </div>
      </article>
    </main>

    <Footer />
  </body>
</html>

<style is:global>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
</style>

<style>
  .blog-post {
    min-height: 70vh;
    padding-top: 140px;
    background: var(--page-bg, #f7f8f7);
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
  }

  .article-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 3rem 1.5rem 5rem;
  }

  .back-link {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    display: inline-block;
    color: var(--kbm-green, #52682d);
    font-weight: 600;
    text-decoration: none;
    margin-bottom: 2rem;
    transition: color 0.3s ease;
  }

  .back-link:hover {
    color: var(--kbm-green-hover, #445626);
    text-decoration: underline;
  }

  .article-header {
    margin-bottom: 3rem;
  }

  .article-date {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    display: block;
    font-size: 0.9375rem;
    color: #718355;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .article-title {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 700;
    color: var(--kbm-green, #52682d);
    line-height: 1.2;
    margin-bottom: 0.75rem;
  }

  .article-author {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    font-size: var(--text-base, 1rem);
    color: #5a6b47;
    font-style: italic;
  }

  .article-content {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    background: white;
    padding: 2.5rem;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    line-height: 1.7;
    font-size: var(--text-base, 1rem);
    color: #2d3a1f;
  }

  .article-content :global(h2) {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    font-size: var(--text-xl, 1.5rem);
    font-weight: 700;
    color: var(--kbm-green, #52682d);
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .article-content :global(h3) {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    font-size: var(--text-lg, 1.125rem);
    font-weight: 600;
    color: #3d4d2f;
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .article-content :global(p) {
    margin-bottom: 1.25rem;
  }

  .article-content :global(ul),
  .article-content :global(ol) {
    margin-bottom: 1.25rem;
    padding-left: 1.75rem;
  }

  .article-content :global(li) {
    margin-bottom: 0.5rem;
  }

  .article-content :global(a) {
    color: var(--kbm-green, #52682d);
    font-weight: 600;
    text-decoration: underline;
  }

  .article-content :global(a:hover) {
    color: var(--kbm-green-hover, #445626);
  }

  .article-content :global(strong) {
    font-weight: 700;
    color: #2d3a1f;
  }

  .article-content :global(blockquote) {
    border-left: 4px solid var(--kbm-green, #52682d);
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #4a5a3a;
  }

  .article-content :global(code) {
    background: #f0f4ea;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-size: 0.9em;
    font-family: 'Courier New', monospace;
  }

  .article-content :global(pre) {
    background: #f0f4ea;
    padding: 1.25rem;
    border-radius: 6px;
    overflow-x: auto;
    margin-bottom: 1.25rem;
  }

  .article-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 1.5rem 0;
  }

  .article-footer {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--ring, #e5e8e0);
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    display: inline-block;
    background: #f0f4ea;
    color: var(--kbm-green, #52682d);
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .article-nav {
    margin-top: 3rem;
    text-align: center;
  }

  .nav-button {
    font-family: var(--font, "Poppins", system-ui, Arial, sans-serif);
    display: inline-block;
    background: var(--kbm-green, #52682d);
    color: white;
    padding: 0.875rem 2rem;
    border-radius: 6px;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.3s ease, transform 0.3s ease;
  }

  .nav-button:hover {
    background: var(--kbm-green-hover, #445626);
    transform: translateY(-2px);
  }

  @media (max-width: 768px) {
    .article-title {
      font-size: clamp(1.75rem, 5vw, 2.5rem);
    }
    
    .article-content {
      padding: 1.5rem;
    }
  }
</style>
