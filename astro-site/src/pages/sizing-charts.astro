---
import Layout from "../layouts/layout.astro";
import Header from "../components/header.astro";
import Footer from "../components/footer.astro";
---

<Layout 
  title="Knitting Sizing Charts | Knit by Machine"
  description="Choose from sweater, hat, mitten, and sock sizing charts for machine knitting. Switch between inches and centimeters and explore measurements tailored to knitters.">

  <Header />

  <main class="page-content sizing-chart-page">

    <div class="sizing-header">
      <h1>Choose a Sizing Chart</h1>
      
      <!-- Unit toggle next to title -->
      <div class="unit-toggle-wrapper">
        <span class="unit-label">in</span>
        <label class="switch">
          <input type="checkbox" id="unitToggle">
          <span class="slider round"></span>
        </label>
        <span class="unit-label">cm</span>
      </div>
    </div>

    <p class="sizing-intro">
      Quickly find standard measurements for your machine-knit projects.
    </p>

    <!-- Project selection buttons -->
    <div class="project-controls">
      <div class="project-pills">
        <div class="dropdown">
          <button class="active" data-type="sweaters_misses">
            <img src="/images/sweater.svg" alt="" class="button-icon" />
            Sweaters ▾
          </button>
          <div class="dropdown-content">
            <button data-type="sweaters_men">Men</button>
            <button data-type="sweaters_misses">Misses</button>
            <button data-type="sweaters_plus">Plus</button>
            <button data-type="sweaters_kids">Kids</button>
            <button data-type="sweaters_baby">Baby</button>
          </div>
        </div>
        <button data-type="hats">
          <img src="/images/hat.svg" alt="" class="button-icon" />
          Hats
        </button>
        <button data-type="mittens">
          <img src="/images/mitten.svg" alt="" class="button-icon" />
          Mittens
        </button>
        <button data-type="socks">
          <img src="/images/sock.svg" alt="" class="button-icon" />
          Socks
        </button>
        <button data-type="blankets">
          <img src="/images/blanket.svg" alt="" class="button-icon" />
          Blankets
        </button>
        <button data-type="pillows">
          <img src="/images/pillow.svg" alt="" class="button-icon" />
          Pillows
        </button>
        <button data-type="xmas_stockings">
          <img src="/images/stocking.svg" alt="" class="button-icon" />
          Christmas Stockings
        </button>
      </div>
    </div>

    <div id="sizingGrid" class="sizing-grid"></div>
    <p id="errorMsg" class="error-message" style="display:none;">Error loading data.</p>

  </main>

  <Footer />

  <style>
    .page-content {
      max-width: 1400px;
      margin: 140px auto 60px;
      padding: 0 20px;
    }

    .sizing-chart-page {
      font-family: "Poppins", sans-serif;
    }

    .sizing-header {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 16px;
      gap: 20px;
    }

    .sizing-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--kbm-green);
      margin: 0;
    }

    .sizing-intro {
      text-align: center;
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 32px;
    }

    .project-controls {
      margin-bottom: 32px;
    }

    .project-pills {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .project-pills button,
    .dropdown > button {
      background: white;
      border: 2px solid var(--kbm-green);
      color: var(--kbm-green);
      padding: 10px 20px;
      border-radius: 24px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: "Poppins", sans-serif;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .button-icon {
      width: 30px;
      height: 30px;
      transition: filter 0.2s ease;
    }

    .project-pills button:hover,
    .dropdown > button:hover {
      background: var(--kbm-green);
      color: white;
    }

    .project-pills button:hover .button-icon,
    .dropdown > button:hover .button-icon {
      filter: brightness(0) invert(1);
    }

    .project-pills button.active,
    .dropdown > button.active {
      background: var(--kbm-green);
      color: white;
    }

    .project-pills button.active .button-icon,
    .dropdown > button.active .button-icon {
      filter: brightness(0) invert(1);
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
      z-index: 1;
      border-radius: 8px;
      overflow: hidden;
      top: 100%;
      margin-top: 4px;
    }

    .dropdown-content button {
      color: var(--kbm-green);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      width: 100%;
      text-align: left;
      border: none;
      border-radius: 0;
      background: white;
      font-size: 0.9rem;
    }

    .dropdown-content button:hover {
      background-color: #f1f1f1;
      color: var(--kbm-green);
    }

    .dropdown:hover .dropdown-content,
    .dropdown > button:focus + .dropdown-content {
      display: block;
    }

    .unit-toggle-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .unit-label {
      font-weight: 600;
      color: var(--kbm-green);
      font-size: 0.95rem;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 26px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--kbm-green);
      transition: 0.3s;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
    }

    input:checked + .slider {
      background-color: var(--kbm-green);
    }

    input:checked + .slider:before {
      transform: translateX(24px);
    }

    .slider.round {
      border-radius: 26px;
    }

    .slider.round:before {
      border-radius: 50%;
    }

    .sizing-grid {
      overflow-x: auto;
      margin-top: 24px;
    }

    .sizing-grid table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    .sizing-grid th {
      background: var(--kbm-green);
      color: white;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      font-size: 0.95rem;
      border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    .sizing-grid td {
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9rem;
    }

    .sizing-grid tr:last-child td {
      border-bottom: none;
    }

    .sizing-grid tr:hover {
      background-color: #f8f8f8;
    }

    .error-message {
      text-align: center;
      color: #e74c3c;
      font-size: 1.1rem;
      padding: 20px;
    }

    @media (max-width: 768px) {
      .sizing-header h1 {
        font-size: 2rem;
      }

      .project-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .project-pills {
        justify-content: center;
      }

      .unit-toggle-wrapper {
        justify-content: center;
      }

      .sizing-grid {
        font-size: 0.85rem;
      }

      .sizing-grid th,
      .sizing-grid td {
        padding: 10px 8px;
        font-size: 0.85rem;
      }
    }
  </style>

  <script>
    // Sizing chart data URLs
    const DATA_URLS = {
      sweaters_men: 'https://sizing-data.netlify.app/sizing_sweaters_men.json',
      sweaters_misses: 'https://sizing-data.netlify.app/sizing_sweaters_misses.json',
      sweaters_plus: 'https://sizing-data.netlify.app/sizing_sweaters_plus.json',
      sweaters_kids: 'https://sizing-data.netlify.app/sizing_sweaters_kids.json',
      sweaters_baby: 'https://sizing-data.netlify.app/sizing_sweaters_baby.json',
      hats: 'https://sizing-data.netlify.app/sizing_hats.json',
      mittens: 'https://sizing-data.netlify.app/sizing_mittens.json',
      socks: 'https://sizing-data.netlify.app/sizing_socks.json',
      blankets: 'https://sizing-data.netlify.app/sizing_blankets.json',
      pillows: 'https://sizing-data.netlify.app/sizing_pillows.json',
      xmas_stockings: 'https://sizing-data.netlify.app/sizing_xmas_stockings.json'
    };

    let currentData = [];
    let currentType = 'sweaters_misses';
    let isMetric = false;

    // Convert inches to centimeters
    function toCm(inches) {
      return (inches * 2.54).toFixed(1);
    }

    // Custom header mappings for specific chart types
    const customHeaders = {
      mittens: {
        'cuff_circumference': 'Cuff<br>Circ.',
        'cuff_length': 'Cuff<br>Length',
        'hand_circumference': 'Hand<br>Circ.',
        'hand_length': 'Hand<br>Length',
        'thumb_length': 'Thumb<br>Length',
        'thumb_opening': 'Thumb<br>Opening'
      }
    };

    // Format label for display
    function formatLabel(key, chartType = null) {
      // Check if there's a custom header for this chart type and key
      if (chartType && customHeaders[chartType] && customHeaders[chartType][key]) {
        return customHeaders[chartType][key];
      }
      
      // Default formatting
      return key
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    // Render the sizing table
    function renderTable(data) {
      const grid = document.getElementById('sizingGrid');
      
      if (!data || data.length === 0) {
        grid.innerHTML = '<p style="text-align: center; padding: 40px;">No data available for this category.</p>';
        return;
      }

      // Get all unique keys from the data
      const allKeys = new Set();
      data.forEach(item => {
        Object.keys(item).forEach(key => {
          if (key !== 'size' && key !== 'label' && key !== 'extended_label' && key !== '' && key !== '__1') {
            allKeys.add(key);
          }
        });
      });

      const headers = ['Size', ...Array.from(allKeys)];

      let html = '<table><thead><tr>';
      headers.forEach(header => {
        const displayHeader = header === 'Size' ? header : formatLabel(header, currentType);
        html += `<th>${displayHeader}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        const displayLabel = row.extended_label || row.label || row.size;
        html += `<td><strong>${displayLabel}</strong></td>`;
        
        Array.from(allKeys).forEach(key => {
          let value = row[key];
          if (value === '' || value === null || value === undefined) {
            html += '<td>—</td>';
          } else if (typeof value === 'number') {
            const displayValue = isMetric ? toCm(value) : value;
            const unit = isMetric ? ' cm' : '″';
            html += `<td>${displayValue}${unit}</td>`;
          } else {
            html += `<td>${value}</td>`;
          }
        });
        
        html += '</tr>';
      });

      html += '</tbody></table>';
      grid.innerHTML = html;
    }

    // Load data for a specific type
    async function loadData(type) {
      const errorMsg = document.getElementById('errorMsg');
      errorMsg.style.display = 'none';

      try {
        const response = await fetch(DATA_URLS[type]);
        if (!response.ok) throw new Error('Failed to load data');
        
        currentData = await response.json();
        renderTable(currentData);
      } catch (error) {
        console.error('Error loading data:', error);
        errorMsg.style.display = 'block';
        errorMsg.textContent = 'Error loading sizing data. Please try again later.';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Load initial data
      loadData(currentType);

      // Handle button clicks
      document.querySelectorAll('.project-pills button, .dropdown-content button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const type = button.dataset.type;
          
          if (type) {
            currentType = type;
            
            // Update active states
            document.querySelectorAll('.project-pills button, .dropdown > button').forEach(btn => {
              btn.classList.remove('active');
            });
            
            // Set active on dropdown button if it's a sweater type
            if (type.startsWith('sweaters_')) {
              document.querySelector('.dropdown > button').classList.add('active');
              document.querySelector('.dropdown > button').textContent = `Sweaters (${formatLabel(type.replace('sweaters_', ''))}) ▾`;
            } else {
              button.classList.add('active');
            }
            
            loadData(type);
          }
        });
      });

      // Handle unit toggle
      document.getElementById('unitToggle').addEventListener('change', (e) => {
        isMetric = e.target.checked;
        renderTable(currentData);
      });
    });
  </script>
</Layout>
