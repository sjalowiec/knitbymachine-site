---
import BaseLayout from '../layouts/BaseLayout.astro';

// Fetch wizard entries from GitHub at build time
let entries = [];
let errorMessage = '';

try {
  const response = await fetch('https://api.github.com/repos/sjalowiec/knitbymachine/contents/src/content/wizards');
  
  if (response.ok) {
    const files = await response.json();
    
    // Fetch each JSON file's content
    const entryPromises = files
      .filter(file => file.name.endsWith('.json'))
      .map(async (file) => {
        const fileResponse = await fetch(file.download_url);
        const data = await fileResponse.json();
        return {
          title: data.title,
          slug: data.slug,
          hero: data.hero || '',
          description: data.description || '',
          category: data.category || 'Uncategorized',
          tags: data.tags || [],
          accessLevel: data.accessLevel || 'free',
          price: data.price || '',
          isDraft: data.isDraft,
          pendingPublish: data.pendingPublish,
          publishedDate: data.publishedDate,
        };
      });
    
    const allEntries = await Promise.all(entryPromises);
    // Filter out drafts and pending publish entries
    entries = allEntries.filter(entry => !entry.isDraft && !entry.pendingPublish);
  }
} catch (error) {
  console.error('Error fetching wizard entries:', error);
  errorMessage = error.message;
}

const title = "Wizards Catalog";
const description = "Browse all our knitting calculators and interactive tools to help you plan your projects with confidence.";
---

<BaseLayout {title} {description}>
  <div class="page-container">
    <!-- Compact Header: Icon + Text + Search/Sort -->
    <div class="header-panel fade-in">
      <img src="/images/wizard-logo.png" alt="Wizards" class="intro-icon">
      <div class="intro-content">
        <p class="intro-tagline">Calculators and tools to make your machine knitting projects easier.</p>
        <p class="intro-subtitle">From gauge calculations to yarn estimations, get the math done right so you can focus on the creative part.</p>
      </div>
      <div class="controls-wrapper">
        <div class="search-wrapper">
          <input 
            type="text" 
            class="search-input" 
            id="searchInput" 
            placeholder="Search wizards..."
            aria-label="Search wizards"
          >
        </div>
        <div class="category-filters">
          <button class="filter-icon active" data-category="all" aria-label="Show all wizards" title="All Wizards">
            <img src="/images/all-wizards.png" alt="All" />
          </button>
          <button class="filter-icon" data-category="Pattern" aria-label="Filter by Pattern" title="Pattern Wizards">
            <img src="/images/pattern_icon.png" alt="Pattern" />
          </button>
          <button class="filter-icon" data-category="Tools" aria-label="Filter by Tools" title="Tools Wizards">
            <img src="/images/tools_icon.png" alt="Tools" />
          </button>
          <button class="filter-icon" data-category="Practice" aria-label="Filter by Skill Builders" title="Skill Builders">
            <img src="/images/practice-icon.png" alt="Skill Builders" />
          </button>
          <button class="filter-icon" data-category="Smart Guides" aria-label="Filter by Smart Guides" title="Smart Guides">
            <img src="/images/guide_icon.png" alt="Smart Guides" />
          </button>
        </div>
      </div>
    </div>

    <!-- Catalogue Content -->
    <div id="catalogueContent" class="catalogue-content" data-entries={JSON.stringify(entries)}>
      {errorMessage && (
        <div class="error">
          <p><strong>Error loading wizards</strong></p>
          <p>Unable to fetch wizard entries. Please try again later.</p>
          <p style="font-size: 0.9rem; margin-top: 1rem;">{errorMessage}</p>
        </div>
      )}
    </div>
  </div>

  <!-- Scroll to Top Button -->
  <button id="scrollToTop" class="scroll-to-top" aria-label="Scroll to top">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>
    </svg>
  </button>
</BaseLayout>

<style>
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4.5rem 1.5rem 3rem;
  }

  /* Compact Header Panel */
  .header-panel {
    background-color: #ffffff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(82, 104, 45, 0.1);
    padding: 1.8rem 2.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
  }

  .intro-icon {
    width: 120px;
    height: 120px;
    flex-shrink: 0;
  }

  .intro-content {
    flex: 1;
    min-width: 300px;
  }

  .intro-tagline {
    color: #52682D;
    font-size: 1.25rem;
    line-height: 1.5;
    margin: 0 0 0.75rem 0;
    opacity: 0.85;
  }

  .intro-subtitle {
    color: #52682D;
    font-size: 1rem;
    line-height: 1.6;
    margin: 0;
    opacity: 0.7;
    max-width: 580px;
  }

  /* Search and Category Filter Controls */
  .controls-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-width: 340px;
  }

  .search-wrapper {
    width: 100%;
  }

  .search-input {
    width: 100%;
    padding: 0.875rem 1.5rem;
    border: 2px solid #c7d8a4;
    border-radius: 50px;
    font-size: 1rem;
    background-color: white;
    transition: all 0.3s ease;
    box-sizing: border-box;
  }

  .search-input:focus {
    outline: none;
    border-color: #52682D;
    box-shadow: 0 0 0 3px rgba(82, 104, 45, 0.1);
  }

  /* Category Filter Icons */
  .category-filters {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-content: center;
  }

  .filter-icon {
    background: transparent;
    border: none;
    border-radius: 12px;
    padding: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 56px;
    min-height: 56px;
  }

  .filter-icon img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    display: block;
    transition: all 0.3s ease;
  }

  .filter-icon:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 4px 8px rgba(82, 104, 45, 0.25));
  }

  .filter-icon.active {
    border: 3px solid #52682D;
    box-shadow: 0 0 0 3px rgba(82, 104, 45, 0.2), 0 4px 12px rgba(82, 104, 45, 0.3);
    background: white;
  }

  .filter-icon.active img {
    filter: none;
  }


  /* Catalogue Content */
  .catalogue-content {
    position: relative;
  }

  /* Consistent Section Titles */
  :global(.section-title) {
    color: #52682D;
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    padding-bottom: 0.75rem;
    position: relative;
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
  }


  :global(.category-icon) {
    width: 52px;
    height: 52px;
    object-fit: contain;
    flex-shrink: 0;
    filter: drop-shadow(0 1px 2px rgba(82, 104, 45, 0.25));
  }

  /* Section Rhythm and Balance */
  :global(.category-section) {
    margin-bottom: 1.5rem;
    padding: 2.5rem;
    border-radius: 12px;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }

  :global(.category-section:nth-child(odd)) {
    background-color: #ffffff;
  }

  :global(.category-section:nth-child(even)) {
    background-color: #f9fdf5;
  }

  :global(.category-section.hidden) {
    display: none;
  }

  :global(.wizards-grid) {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
  }

  /* Wizard Cards */
  :global(.wizard-card) {
    position: relative;
    background-color: #ffffff;
    color: #52682D;
    border: 2px solid #c7d8a4;
    padding: 2rem;
    border-radius: 16px;
    text-decoration: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    cursor: pointer;
    opacity: 0;
    transform: translateY(20px);
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  :global(.wizard-card.animate-in) {
    opacity: 1;
    transform: translateY(0);
  }

  :global(.wizard-card:hover) {
    background-color: #f6f8f2;
    transform: translateY(-6px);
    box-shadow: 0 12px 24px rgba(82, 104, 45, 0.15);
    border-color: #52682D;
  }

  :global(.wizard-card-title) {
    font-size: 1.4rem;
    font-weight: 700;
    color: #52682D;
    margin: 0;
    line-height: 1.3;
  }

  :global(.wizard-card-description) {
    font-size: 1rem;
    color: #6b7280;
    line-height: 1.6;
    margin: 0;
    flex-grow: 1;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  :global(.wizard-card-badge) {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    align-self: flex-start;
  }

  :global(.badge-free) {
    background-color: #C7D8A4;
    color: #52682D;
  }

  :global(.badge-paid) {
    background-color: #52682D;
    color: white;
  }

  :global(.badge-membership) {
    background-color: #8BA556;
    color: white;
  }

  :global(.badge-bundle) {
    background-color: #C7D8A4;
    color: #52682D;
  }

  :global(.wizard-card.card-hidden) {
    display: none;
  }

  /* Scroll to Top Button */
  .scroll-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #52682D;
    color: white;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(82, 104, 45, 0.3);
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1000;
  }

  .scroll-to-top.visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }

  .scroll-to-top:hover {
    background-color: #3e5023;
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(82, 104, 45, 0.4);
  }

  .scroll-to-top svg {
    width: 24px;
    height: 24px;
  }

  /* Smooth Motion and Transitions */
  .fade-in {
    animation: fadeInUp 0.6s ease-out forwards;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .error {
    text-align: center;
    padding: 3rem;
    color: #d64545;
    background-color: #ffe5e5;
    border-radius: 10px;
    margin: 2rem;
  }

  :global(.no-results) {
    text-align: center;
    padding: 3rem;
    color: #666;
    font-style: italic;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .page-container {
      padding: 2rem 1rem;
    }

    .header-panel {
      flex-direction: column;
      text-align: center;
      padding: 1.5rem;
      gap: 1.25rem;
    }

    .intro-icon {
      width: 120px;
      height: 120px;
    }

    .intro-content {
      min-width: unset;
    }

    .intro-tagline {
      font-size: 1.1rem;
    }

    .intro-subtitle {
      font-size: 0.95rem;
      max-width: 100%;
    }

    .controls-wrapper {
      width: 100%;
      max-width: 100%;
    }

    .search-wrapper {
      width: 100%;
    }

    .category-filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }

    .filter-icon {
      min-width: 60px;
      min-height: 60px;
      padding: 6px;
      margin: 0 8px;
    }

    .filter-icon img {
      width: 56px;
      height: 56px;
      transition: all 0.2s ease-in-out;
    }

    .filter-icon:hover img,
    .filter-icon:active img {
      transform: scale(1.05);
    }

    .filter-icon .filter-text {
      font-size: 0.65rem;
    }

    :global(.category-section) {
      padding: 1.5rem 1rem;
      margin-bottom: 2.5rem;
    }

    :global(.section-title) {
      font-size: 1.5rem;
    }

    :global(.wizards-grid) {
      grid-template-columns: 1fr;
    }

    .scroll-to-top {
      bottom: 1.5rem;
      right: 1.5rem;
      width: 45px;
      height: 45px;
    }
  }
</style>

<script>
  let allEntries = [];
  let displayedEntries = [];
  let currentCategory = 'all';

  function sortEntries(entries, sortBy) {
    const sorted = [...entries];
    
    switch(sortBy) {
      case 'newest':
        sorted.sort((a, b) => {
          const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
          const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
          return dateB - dateA;
        });
        break;
      case 'oldest':
        sorted.sort((a, b) => {
          const dateA = a.publishedDate ? new Date(a.publishedDate) : new Date(0);
          const dateB = b.publishedDate ? new Date(b.publishedDate) : new Date(0);
          return dateA - dateB;
        });
        break;
      case 'alphabetical':
        sorted.sort((a, b) => a.title.localeCompare(b.title));
        break;
    }
    
    return sorted;
  }

  function groupByCategory(entries) {
    const grouped = {};
    entries.forEach(entry => {
      if (!grouped[entry.category]) {
        grouped[entry.category] = [];
      }
      grouped[entry.category].push(entry);
    });
    return grouped;
  }

  function getCategoryIcon(category) {
    const categoryLower = category.toLowerCase();
    if (categoryLower.includes('pattern')) {
      return '/images/pattern_icon.png';
    } else if (categoryLower.includes('practice')) {
      return '/images/practice-icon.png';
    } else if (categoryLower.includes('calculator') || categoryLower.includes('tool')) {
      return '/images/tools_icon.png';
    } else if (categoryLower.includes('guide') || categoryLower.includes('smart')) {
      return '/images/guide_icon.png';
    }
    // Default to tools icon
    return '/images/tools_icon.png';
  }

  function renderCatalogue(entries) {
    const container = document.getElementById('catalogueContent');
    
    // Filter by category if one is selected
    let filteredEntries = entries;
    if (currentCategory !== 'all') {
      filteredEntries = entries.filter(entry => {
        const entryCategory = (entry.category || '').toLowerCase();
        const selectedCategory = currentCategory.toLowerCase();
        
        // Match if the entry category contains the selected category
        // This handles cases like "Tools" matching "Calculator Tools" or just "Tools"
        return entryCategory.includes(selectedCategory) || 
               selectedCategory.includes(entryCategory) ||
               entry.category === currentCategory;
      });
    }
    
    const sortedEntries = sortEntries(filteredEntries, 'alphabetical');
    const grouped = groupByCategory(sortedEntries);
    const categories = Object.keys(grouped).sort();

    if (categories.length === 0) {
      container.innerHTML = '<div class="no-results">No wizards found matching your search.</div>';
      return;
    }

    let html = '';

    categories.forEach(category => {
      const categoryEntries = grouped[category];
      const categoryIcon = getCategoryIcon(category);

      html += `
        <div class="category-section" data-category="${category}">
          <h2 class="section-title">
            <img src="${categoryIcon}" alt="${category}" class="category-icon" />
            <span>${category}</span>
          </h2>
          <div class="wizards-grid">
            ${categoryEntries.map(entry => {
              const badgeClass = `badge-${entry.accessLevel}`;
              const badgeText = entry.accessLevel === 'paid' && entry.price 
                ? `$${entry.price}` 
                : entry.accessLevel.charAt(0).toUpperCase() + entry.accessLevel.slice(1);
              
              return `
                <a href="/wizards/${entry.slug}"
                  class="wizard-card"
                  data-title="${entry.title.toLowerCase()}"
                  data-tags="${entry.tags.join(' ').toLowerCase()}">
                  <h3 class="wizard-card-title">${entry.title}</h3>
                  ${entry.description ? `<p class="wizard-card-description">${entry.description}</p>` : ''}
                  ${entry.accessLevel !== 'free' ? `<span class="wizard-card-badge ${badgeClass}">${badgeText}</span>` : ''}
                </a>
              `;
            }).join('')}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
    
    // Initialize scroll animations after render
    setTimeout(() => {
      initializeScrollAnimations();
    }, 100);
  }

  // Intersection Observer for scroll-triggered card animations
  function initializeScrollAnimations() {
    const cards = document.querySelectorAll('.wizard-card');
    
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry, index) => {
        if (entry.isIntersecting) {
          // Stagger animation
          setTimeout(() => {
            entry.target.classList.add('animate-in');
          }, index * 50);
          
          observer.unobserve(entry.target);
        }
      });
    }, {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    });

    cards.forEach(card => {
      observer.observe(card);
    });
  }

  function filterCatalogue(searchTerm) {
    const term = searchTerm.toLowerCase().trim();
    const sections = document.querySelectorAll('.category-section');

    sections.forEach(section => {
      const cards = section.querySelectorAll('.wizard-card');
      let hasVisibleCards = false;

      cards.forEach(card => {
        const title = card.dataset.title;
        const tags = card.dataset.tags;
        const matches = title.includes(term) || tags.includes(term);

        if (matches) {
          card.classList.remove('card-hidden');
          hasVisibleCards = true;
        } else {
          card.classList.add('card-hidden');
        }
      });

      if (hasVisibleCards) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    });
  }

  // Scroll to Top Button
  function initializeScrollToTop() {
    const scrollBtn = document.getElementById('scrollToTop');
    
    window.addEventListener('scroll', () => {
      if (window.scrollY > 300) {
        scrollBtn.classList.add('visible');
      } else {
        scrollBtn.classList.remove('visible');
      }
    });

    scrollBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  }

  function init() {
    const container = document.getElementById('catalogueContent');
    const entriesData = container.getAttribute('data-entries');
    
    if (entriesData) {
      allEntries = JSON.parse(entriesData);
      displayedEntries = allEntries;
      
      // Check for category filter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const categoryFilter = urlParams.get('category');
      
      if (categoryFilter) {
        currentCategory = categoryFilter;
        
        // Update active state on filter buttons
        document.querySelectorAll('.filter-icon').forEach(btn => {
          btn.classList.remove('active');
          if (btn.dataset.category === categoryFilter) {
            btn.classList.add('active');
          }
        });
      }
      
      renderCatalogue(displayedEntries);
    }

    initializeScrollToTop();
  }

  document.getElementById('searchInput')?.addEventListener('input', (e) => {
    filterCatalogue(e.target.value);
  });

  // Category filter buttons
  document.querySelectorAll('.filter-icon').forEach(button => {
    button.addEventListener('click', () => {
      const category = button.dataset.category;
      
      // Update active state
      document.querySelectorAll('.filter-icon').forEach(btn => {
        btn.classList.remove('active');
      });
      button.classList.add('active');
      
      // Update current category and re-render
      currentCategory = category;
      displayedEntries = allEntries;
      renderCatalogue(displayedEntries);
      
      // Re-apply search if there's a search term
      const searchTerm = document.getElementById('searchInput').value;
      if (searchTerm) {
        filterCatalogue(searchTerm);
      }
    });
  });

  init();
</script>
