---
import BaseLayout from "../../layouts/BaseLayout.astro";
import ActionBar from "../../components/wizards/ActionBar.astro";
import UnitToggle from "../../components/wizards/components/UnitToggle.astro";
import PatternDiagram from "../../components/wizards/PatternDiagram.astro";

// Import shared wizard styles
import '../../styles/wizard.css';
---

<BaseLayout 
  title="Hat Builder | Knit by Machine" 
  description="Design your perfect custom hat with precise sizing, brim options, and crown shaping. Get complete knitting instructions with an illustrated diagram.">

<style>
/* Hat-specific styles only */
.back-link {
  display: inline-block;
  color: #52682D;
  text-decoration: none;
  font-weight: 500;
  margin-bottom: 1.5rem;
  padding: 0.5rem 0;
  transition: color 0.2s;
}

.back-link:hover {
  color: #3d4e21;
  text-decoration: underline;
}

.title-icon {
  width: 48px;
  height: 48px;
  vertical-align: middle;
  margin-right: 0.75rem;
  display: inline-block;
}

/* Print-specific overrides for hat patterns */
@media print {
  * {
    background: white !important;
    background-color: white !important;
  }
  
  body {
    background: white !important;
  }
  
  .page-header, .video-button {
    display: none;
  }
  
  .highlight-box {
    background: white !important;
    border-left: 2px solid #333 !important;
    padding: 0.5rem !important;
  }
  
  .print-footer {
    display: block !important;
    text-align: center;
    font-family: "Poppins", Arial, sans-serif;
    font-size: 10pt;
    color: #666;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid #ddd;
    background: white !important;
  }
}
</style>

<div class="wizard-page">
  <div style="max-width: 800px; margin: 0 auto; padding: 0 1rem;">
    <a href="/wizards-catalog" class="back-link">← Back to Wizards Catalog</a>
  </div>

  <div class="page-header no-print">
    <div class="page-header-title">
      <h1>
        <img src="/images/hat.svg" alt="Hat" class="title-icon" />
        Hat Builder
      </h1>
      <button class="video-button" onclick="alert('Video tutorial coming soon!')">
        <i class="fas fa-play-circle"></i> Watch Tutorial
      </button>
    </div>
    <p>
      Design the perfect custom hat with precise sizing, brim options, and crown shaping. Get complete knitting instructions with an illustrated diagram.
    </p>
  </div>
  
  <div class="wizard-container">
    <div class="calculator-card">
      <!-- Reusable Unit Toggle Component -->
      <UnitToggle id="hat" />

      <!-- Size Selection -->
      <h3 class="section-title">Hat Size</h3>
      
      <div class="checkbox-group">
        <input type="checkbox" id="use-custom" data-testid="checkbox-custom-size">
        <label for="use-custom">Use Custom Head Circumference</label>
      </div>

      <div id="standard-size" style="display: block;">
        <div class="input-group">
          <label for="hat-size">Select Standard Size</label>
          <select id="hat-size" data-testid="select-hat-size">
            <option value="">Choose a size...</option>
          </select>
        </div>
      </div>

      <div id="custom-size" style="display: none;">
        <div class="input-group">
          <label for="custom-circumference">Head Circumference</label>
          <input 
            type="number" 
            id="custom-circumference" 
            step="0.25" 
            placeholder="Enter head circumference"
            data-testid="input-custom-circumference"
          />
        </div>
      </div>

      <!-- Brim Style -->
      <h3 class="section-title">Brim Style</h3>
      <div class="input-group">
        <label for="brim">Brim Type</label>
        <select id="brim" data-testid="select-brim">
          <option value="rib">Ribbed (1x1, 2x2, or Mock Ribbing)</option>
          <option value="roll">Rolled Edge</option>
          <option value="fold">Fold-Up Brim</option>
          <option value="hem">Hung Hem</option>
        </select>
      </div>

      <!-- Crown Shaping -->
      <h3 class="section-title">Crown Shaping</h3>
      <div class="input-group">
        <label for="crown">Crown Style</label>
        <select id="crown" data-testid="select-crown">
          <option value="gathered">Gathered (cinched top)</option>
          <option value="wedge-4">4-Wedge Decreases</option>
          <option value="wedge-6">6-Wedge Decreases</option>
          <option value="spiral">Spiral Decreases</option>
        </select>
      </div>

      <!-- Fit Type -->
      <h3 class="section-title">Hat Fit</h3>
      <div class="input-group">
        <label for="fit">Fit Style</label>
        <select id="fit" data-testid="select-fit">
          <option value="beanie">Beanie (7" total height)</option>
          <option value="watchcap">Watch Cap (8.5" total height)</option>
          <option value="slouchy">Slouchy (10" total height)</option>
          <option value="relaxed">Relaxed (9" total height)</option>
        </select>
      </div>

      <!-- Gauge -->
      <h3 class="section-title">Your Gauge</h3>
      <div class="input-grid">
        <div class="input-group">
          <label for="stitch-gauge">Stitch Gauge</label>
          <input 
            type="number" 
            id="stitch-gauge" 
            step="0.1" 
            placeholder="stitches per 4&quot;"
            data-testid="input-stitch-gauge"
          />
        </div>
        <div class="input-group">
          <label for="row-gauge">Row Gauge</label>
          <input 
            type="number" 
            id="row-gauge" 
            step="0.1" 
            placeholder="rows per 4&quot;"
            data-testid="input-row-gauge"
          />
        </div>
      </div>

      <!-- Results Section -->
      <div id="results" style="display: none;">
        <ActionBar />
        
        <div class="results-section">
          <div class="pattern-card">
            <div id="pattern-content">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div class="diagram-container">
            <h3>Hat Dimensions</h3>
            <div id="diagram-content">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
          
          <div id="print-footer" class="print-footer" style="display: none;">
            Generated by knitbymachine.com - Hat Builder
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Load shared wizard utilities -->
<script is:inline src="/js/wizard-utils.js"></script>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  console.log('Hat Builder initializing...');
  
  // Use shared wizard utilities from window.WizardUtils (or shorthand WU)
  const {
    convertLength,
    formatLength,
    formatLengthWithUnit,
    gaugeToPerUnit,
    getPlaceholders,
    createUnitStore,
    showResults,
    setupAutoCalculate,
    updateHTML
  } = window.WizardUtils;
  
  // ========== HAT BUILDER SPECIFIC CODE ==========
  
  // State
  let hatSizingData = [];
  const unitStore = createUnitStore('hat-unit', 'inches');
  
  // DOM Elements
  const btnInches = document.getElementById('hat-btn-inches');
  const btnCm = document.getElementById('hat-btn-cm');
  const useCustomCheckbox = document.getElementById('use-custom');
  const standardSizeDiv = document.getElementById('standard-size');
  const customSizeDiv = document.getElementById('custom-size');
  const hatSizeSelect = document.getElementById('hat-size');
  const customCircInput = document.getElementById('custom-circumference');
  const brimSelect = document.getElementById('brim');
  const crownSelect = document.getElementById('crown');
  const fitSelect = document.getElementById('fit');
  const stitchGaugeInput = document.getElementById('stitch-gauge');
  const rowGaugeInput = document.getElementById('row-gauge');
  const printBtn = document.getElementById('print-btn');
  const startOverBtn = document.getElementById('start-over-btn');
  
  // Load hat sizing data
  try {
    const response = await fetch('/data/sizing_hats.json');
    hatSizingData = await response.json();
    console.log('Loaded hat sizing data:', hatSizingData.length, 'sizes');
    
    // Populate size dropdown
    hatSizingData.forEach(size => {
      const option = document.createElement('option');
      option.value = size.size;
      option.textContent = size.extended_label;
      hatSizeSelect.appendChild(option);
    });
  } catch (error) {
    console.error('Failed to load hat sizing data:', error);
  }
  
  // Unit Toggle
  function updateUnitToggle() {
    const currentUnit = unitStore.get();
    if (currentUnit === 'inches') {
      btnInches.classList.add('active');
      btnCm.classList.remove('active');
    } else {
      btnCm.classList.add('active');
      btnInches.classList.remove('active');
    }
    updatePlaceholders();
  }
  
  function updatePlaceholders() {
    const currentUnit = unitStore.get();
    const placeholders = getPlaceholders(currentUnit);
    
    stitchGaugeInput.placeholder = placeholders.stitchGauge;
    rowGaugeInput.placeholder = placeholders.rowGauge;
    customCircInput.placeholder = placeholders.circumference;
  }
  
  btnInches.addEventListener('click', () => {
    unitStore.set('inches');
    updateUnitToggle();
    const resultsDiv = document.getElementById('results');
    if (resultsDiv.style.display === 'block') calculate();
  });
  
  btnCm.addEventListener('click', () => {
    unitStore.set('cm');
    updateUnitToggle();
    const resultsDiv = document.getElementById('results');
    if (resultsDiv.style.display === 'block') calculate();
  });
  
  updateUnitToggle();
  
  // Custom Size Toggle
  useCustomCheckbox.addEventListener('change', (e) => {
    if (e.target.checked) {
      standardSizeDiv.style.display = 'none';
      customSizeDiv.style.display = 'block';
      hatSizeSelect.value = '';
    } else {
      standardSizeDiv.style.display = 'block';
      customSizeDiv.style.display = 'none';
      customCircInput.value = '';
    }
  });
  
  // Auto-calculate
  setupAutoCalculate(
    [hatSizeSelect, customCircInput, brimSelect, crownSelect, fitSelect, stitchGaugeInput, rowGaugeInput],
    calculate
  );
  
  // Action Bar
  printBtn.addEventListener('click', () => {
    window.print();
  });
  
  startOverBtn.addEventListener('click', () => {
    hatSizeSelect.value = '';
    customCircInput.value = '';
    useCustomCheckbox.checked = false;
    standardSizeDiv.style.display = 'block';
    customSizeDiv.style.display = 'none';
    brimSelect.value = 'rib';
    crownSelect.value = 'gathered';
    fitSelect.value = 'beanie';
    stitchGaugeInput.value = '';
    rowGaugeInput.value = '';
    document.getElementById('results').style.display = 'none';
    document.getElementById('action-bar').style.display = 'none';
  });
  
  // Calculate Function
  function calculate() {
    const currentUnit = unitStore.get();
    
    // Get head circumference
    let headCirc = 0;
    let depth = 7; // default beanie depth
    
    if (useCustomCheckbox.checked) {
      headCirc = parseFloat(customCircInput.value) || 0;
    } else {
      const selectedSize = hatSizingData.find(s => s.size === hatSizeSelect.value);
      if (selectedSize) {
        headCirc = selectedSize.circumference;
        depth = selectedSize.depth;
      }
    }
    
    // Get other inputs
    const brim = brimSelect.value;
    const crown = crownSelect.value;
    const fit = fitSelect.value;
    const stitchGauge = parseFloat(stitchGaugeInput.value) || 0;
    const rowGauge = parseFloat(rowGaugeInput.value) || 0;
    
    // Validate
    if (!headCirc || !stitchGauge || !rowGauge) {
      return; // Not ready yet
    }
    
    // Convert to inches for calculations
    const headCircInches = currentUnit === 'inches' 
      ? headCirc 
      : convertLength(headCirc, 'cm', 'inches');
    
    const stGaugePerInch = gaugeToPerUnit(stitchGauge, currentUnit);
    const rowGaugePerInch = gaugeToPerUnit(rowGauge, currentUnit);
    
    // Calculations
    const negativeEase = 0.90;
    const targetWidth = headCircInches * negativeEase;
    const castOnSts = Math.round(targetWidth * stGaugePerInch);
    
    // Hat heights
    const fitHeights = {
      beanie: depth || 7,
      watchcap: 8.5,
      slouchy: 10,
      relaxed: 9
    };
    const hatHeight = fitHeights[fit];
    
    // Brim calculations
    const brimDepths = {
      rib: 2,
      roll: 1.5,
      fold: 3,
      hem: 2.5
    };
    const brimDepth = brimDepths[brim];
    const brimRows = Math.round(brimDepth * rowGaugePerInch);
    
    // Crown calculations
    const crownStart = hatHeight - brimDepth;
    const crownRows = Math.round((hatHeight - crownStart) * rowGaugePerInch);
    
    // Generate pattern
    generatePattern({
      headCircInches,
      targetWidth,
      castOnSts,
      hatHeight,
      brimDepth,
      brimRows,
      crownStart,
      crownRows,
      brim,
      crown,
      fit,
      stGaugePerInch,
      rowGaugePerInch
    });
    
    // Show results
    showResults({
      resultsSelector: '#results',
      actionBarSelector: '#action-bar',
      printButtonSelector: '#print-btn',
      printFooterSelector: '#print-footer'
    });
  }
  
  function generatePattern(calc) {
    const currentUnit = unitStore.get();
    const { headCircInches, targetWidth, castOnSts, hatHeight, brimDepth, brimRows, crownStart, crownRows, brim, crown, fit, stGaugePerInch, rowGaugePerInch } = calc;
    
    // Convert display values
    const displayHeadCirc = currentUnit === 'inches' 
      ? formatLength(headCircInches, 'inches')
      : formatLength(convertLength(headCircInches, 'inches', 'cm'), 'cm');
    
    const displayWidth = currentUnit === 'inches'
      ? formatLength(targetWidth, 'inches')
      : formatLength(convertLength(targetWidth, 'inches', 'cm'), 'cm');
    
    const displayHeight = currentUnit === 'inches'
      ? formatLength(hatHeight, 'inches')
      : formatLength(convertLength(hatHeight, 'inches', 'cm'), 'cm');
    
    const displayBrimDepth = currentUnit === 'inches'
      ? formatLength(brimDepth, 'inches')
      : formatLength(convertLength(brimDepth, 'inches', 'cm'), 'cm');
    
    const unit = currentUnit === 'inches' ? 'inches' : 'cm';
    
    // Brim instructions
    const brimInstructions = {
      rib: 'Work in 1x1 or 2x2 ribbing (knit 1, purl 1, or knit 2, purl 2 across all stitches). For Mock Ribbing: Work in stockinette and use slip stitch technique to create ribbed appearance.',
      roll: 'Work in stockinette stitch. The edge will naturally roll.',
      fold: 'Work in stockinette stitch for a fold-up brim. Fold up when wearing.',
      hem: 'Work stockinette for half the brim depth, place a turning row (purl on knit side or use picot edge), then work stockinette for remaining rows. Fold at turning row and tack hem to wrong side.'
    };
    
    // Crown shaping
    const bodyRows = Math.round((crownStart - brimDepth) * rowGaugePerInch);
    let crownInstructions = '';
    
    if (crown === 'gathered') {
      crownInstructions = `
        <p><strong>Gathered Crown:</strong></p>
        <p>Work ${bodyRows} rows in stockinette stitch after brim.</p>
        <p>Cut yarn leaving a 20" tail. Thread through all ${castOnSts} stitches, pull tight to gather, and secure.</p>
      `;
    } else if (crown === 'wedge-4') {
      const stsPerWedge = Math.floor(castOnSts / 4);
      const decreaseRounds = Math.ceil(stsPerWedge / 2);
      crownInstructions = `
        <p><strong>4-Wedge Crown:</strong></p>
        <p>Work ${bodyRows} rows in stockinette stitch after brim.</p>
        <p>Place 4 markers evenly around hat (every ${stsPerWedge} stitches).</p>
        <p>Decrease Round: *Knit to 2 stitches before marker, k2tog, slip marker*. Repeat around all 4 markers.</p>
        <p>Repeat decrease round every other row ${decreaseRounds} times until 8-12 stitches remain.</p>
        <p>Cut yarn, thread through remaining stitches, pull tight, and secure.</p>
      `;
    } else if (crown === 'wedge-6') {
      const stsPerWedge = Math.floor(castOnSts / 6);
      const decreaseRounds = Math.ceil(stsPerWedge / 2);
      crownInstructions = `
        <p><strong>6-Wedge Crown:</strong></p>
        <p>Work ${bodyRows} rows in stockinette stitch after brim.</p>
        <p>Place 6 markers evenly around hat (every ${stsPerWedge} stitches).</p>
        <p>Decrease Round: *Knit to 2 stitches before marker, k2tog, slip marker*. Repeat around all 6 markers.</p>
        <p>Repeat decrease round every other row ${decreaseRounds} times until 12-18 stitches remain.</p>
        <p>Cut yarn, thread through remaining stitches, pull tight, and secure.</p>
      `;
    } else if (crown === 'spiral') {
      const decreaseInterval = Math.floor(castOnSts / 8);
      crownInstructions = `
        <p><strong>Spiral Crown:</strong></p>
        <p>Work ${bodyRows} rows in stockinette stitch after brim.</p>
        <p>Decrease Round: *K${decreaseInterval - 2}, k2tog*. Repeat around.</p>
        <p>Knit 2 rounds even.</p>
        <p>Next Decrease: *K${decreaseInterval - 3}, k2tog*. Repeat around.</p>
        <p>Continue decreasing every 3rd round, working 1 less stitch between decreases, until 8-12 stitches remain.</p>
        <p>Cut yarn, thread through remaining stitches, pull tight, and secure.</p>
      `;
    }
    
    // Pattern HTML
    const patternHTML = `
      <h3>Your Custom Hat Pattern</h3>
      
      <div class="highlight-box">
        <p><strong>Finished Measurements:</strong></p>
        <p>Head Circumference: ${displayHeadCirc} ${unit} → Hat Width: ${displayWidth} ${unit} (with negative ease)</p>
        <p>Total Height: ${displayHeight} ${unit} | Brim Depth: ${displayBrimDepth} ${unit}</p>
      </div>
      
      <h4>Materials</h4>
      <p>• Yarn of your choice</p>
      <p>• Stitch markers (for wedge crowns)</p>
      <p>• Tapestry needle</p>
      
      <h4>Gauge</h4>
      <p>${stGaugePerInch.toFixed(1)} stitches per inch | ${rowGaugePerInch.toFixed(1)} rows per inch</p>
      
      <h4>Cast-On</h4>
      <p>Cast on <strong>${castOnSts} stitches</strong>.</p>
      
      <h4>Brim (${displayBrimDepth} ${unit})</h4>
      <p>Work ${brimRows} rows:</p>
      <p>${brimInstructions[brim]}</p>
      
      <h4>Body</h4>
      <p>Switch to stockinette stitch and continue for body of hat.</p>
      
      <h4>Crown Shaping</h4>
      ${crownInstructions}
      
      <h4>Finishing</h4>
      <p>Seam the hat using mattress stitch or your preferred method. Weave in all ends and block if desired.</p>
    `;
    
    updateHTML('#pattern-content', patternHTML);
    
    // Generate diagram
    generateDiagram(calc);
  }
  
  async function generateDiagram(calc) {
    const currentUnit = unitStore.get();
    const { hatHeight, brimDepth, targetWidth } = calc;
    
    // Format values with units
    const displayWidth = formatLengthWithUnit(
      currentUnit === 'inches' ? targetWidth : convertLength(targetWidth, 'inches', currentUnit),
      currentUnit
    );
    
    const displayHeight = formatLengthWithUnit(
      currentUnit === 'inches' ? hatHeight : convertLength(hatHeight, 'inches', currentUnit),
      currentUnit
    );
    
    const displayBrimDepth = formatLengthWithUnit(
      currentUnit === 'inches' ? brimDepth : convertLength(brimDepth, 'inches', currentUnit),
      currentUnit
    );
    
    // Map crown type to template name
    const crown = crownSelect.value;
    let templateName;
    
    // Map crown values to correct SVG filenames
    if (crown === 'wedge-4') {
      templateName = 'hat-4-wedge';
    } else if (crown === 'wedge-6') {
      templateName = 'hat-6-wedge';
    } else {
      templateName = `hat-${crown}`; // gathered, spiral
    }
    
    try {
      // Load SVG template from diagrams directory
      const response = await fetch(`/diagrams/${templateName}.svg`);
      let svgContent = await response.text();
      
      // Replace placeholders with fully-formatted values (including units)
      svgContent = svgContent
        .replace(/{{WIDTH}}/g, displayWidth)
        .replace(/{{HEIGHT}}/g, displayHeight)
        .replace(/{{BRIM_DEPTH}}/g, displayBrimDepth);
      
      updateHTML('#diagram-content', svgContent);
    } catch (error) {
      console.error('Failed to load diagram template:', templateName, error);
      updateHTML('#diagram-content', '<p style="text-align: center; color: #6b7280;">Diagram unavailable</p>');
    }
  }
});
</script>

</BaseLayout>
