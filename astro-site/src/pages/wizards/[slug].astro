---
export const prerender = false;

import BaseLayout from "../../layouts/BaseLayout.astro";

const { slug } = Astro.params;

const GITHUB_TOKEN = import.meta.env.GITHUB_TOKEN || process.env.GITHUB_TOKEN;
const REPO_OWNER = 'sjalowiec';
const REPO_NAME = 'knitbymachine';
const CONTENT_PATH = 'src/content/wizards';

async function getWizardEntry(slug: string) {
  try {
    const response = await fetch(
      `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${CONTENT_PATH}/${slug}.json`,
      {
        headers: {
          'Authorization': `token ${GITHUB_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'User-Agent': 'knitbymachine-astro'
        }
      }
    );

    if (!response.ok) {
      return null;
    }

    const data = await response.json();
    const content = atob(data.content);
    const jsonData = JSON.parse(content);

    // Filter out drafts and pending publish entries
    if (jsonData.isDraft || jsonData.pendingPublish) {
      return null;
    }

    return {
      data: jsonData,
      slug: slug
    };
  } catch (error) {
    console.error('Error fetching wizard entry:', error);
    return null;
  }
}

const entry = await getWizardEntry(slug);

if (!entry) {
  return Astro.redirect('/404');
}

const { title, hero, description, videoUrl, accessLevel, price, relatedAnas, relatedWorkshops, imageUrl, imageAlt, schemaMarkup } = entry.data;
---

<BaseLayout title={title}>
  {schemaMarkup && (
    <script type="application/ld+json" set:html={JSON.stringify(schemaMarkup)} slot="head"></script>
  )}
  
  <div class="wizard-container">
    <a href="/wizards-catalog" class="back-link">‚Üê Back to Wizards</a>
    
    <div class="wizard-header">
      <h1>{title}</h1>
      {hero && <p class="hero-tagline">{hero}</p>}
      
      {accessLevel && accessLevel !== 'free' && (
        <div class="access-badge">
          <span class={`badge badge-${accessLevel}`}>
            {accessLevel === 'paid' && price ? `$${price}` : accessLevel.charAt(0).toUpperCase() + accessLevel.slice(1)}
          </span>
        </div>
      )}
    </div>

    {imageUrl && (
      <div class="hero-image-container">
        <img 
          src={imageUrl} 
          alt={imageAlt || title}
          class="hero-image"
        />
      </div>
    )}

    <div class="wizard-content">
      {description && <div class="description" set:html={description}></div>}
      
      {videoUrl && (
        <div class="video-container">
          <iframe
            src={videoUrl}
            width="100%"
            height="480"
            frameborder="0"
            allowfullscreen
            title={`${title} video`}
          ></iframe>
        </div>
      )}
      
      {relatedAnas && relatedAnas.length > 0 && (
        <div class="related-section">
          <h2>Related Ask 'n Answer</h2>
          <ul class="related-list">
            {relatedAnas.map((anaSlug: string) => (
              <li><a href={`/ana/${anaSlug}`}>{anaSlug}</a></li>
            ))}
          </ul>
        </div>
      )}
      
      {relatedWorkshops && relatedWorkshops.length > 0 && (
        <div class="related-section">
          <h2>Related Workshops</h2>
          <ul class="related-list">
            {relatedWorkshops.map((workshopSlug: string) => (
              <li><a href={`/workshops/${workshopSlug}`}>{workshopSlug}</a></li>
            ))}
          </ul>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  .wizard-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .back-link {
    display: inline-block;
    margin-bottom: 2rem;
    color: #52682D;
    font-size: 0.95rem;
    font-weight: 500;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease-in-out;
  }

  .back-link:hover {
    border-bottom: 1px solid #C7D8A4;
    color: #3E5524;
  }

  .wizard-header {
    margin-bottom: 2rem;
  }

  .wizard-header h1 {
    color: #52682D;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 1rem;
  }

  .hero-tagline {
    color: #52682D;
    font-size: 1.3rem;
    font-weight: 500;
    margin-bottom: 1rem;
    font-style: italic;
  }

  .access-badge {
    margin-top: 1rem;
  }

  .badge {
    display: inline-block;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-paid {
    background-color: #52682D;
    color: white;
  }

  .badge-membership {
    background-color: #8BA556;
    color: white;
  }

  .badge-bundle {
    background-color: #C7D8A4;
    color: #52682D;
  }

  .hero-image-container {
    margin: 2rem 0;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(82, 104, 45, 0.15);
  }

  .hero-image {
    width: 100%;
    height: auto;
    display: block;
  }

  .wizard-content {
    background-color: #f3f7ec;
    padding: 2rem;
    border-radius: 12px;
  }

  .description {
    color: #52682D;
    font-size: 1.1rem;
    line-height: 1.8;
    margin-bottom: 2rem;
  }

  .description :global(p) {
    margin-bottom: 1rem;
  }

  .description :global(p:last-child) {
    margin-bottom: 0;
  }

  .video-container {
    margin: 2rem 0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(82, 104, 45, 0.1);
  }

  .related-section {
    margin-top: 2rem;
  }

  .related-section h2 {
    color: #52682D;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .related-list {
    list-style: none;
    padding: 0;
  }

  .related-list li {
    margin-bottom: 0.5rem;
  }

  .related-list a {
    color: #52682D;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease-in-out;
  }

  .related-list a:hover {
    border-bottom: 1px solid #C7D8A4;
    color: #3E5524;
  }

  @media (max-width: 768px) {
    .wizard-header h1 {
      font-size: 2rem;
    }

    .hero-tagline {
      font-size: 1.1rem;
    }

    .wizard-content {
      padding: 1.5rem;
    }

    .video-container iframe {
      height: 300px;
    }
  }
</style>
